<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Maseno Judicial Attachment Portal</title>
  <style>
    :root {
      --primary: #1a3c5e; /* Judiciary Blue */
      --primary-dark: #122b44;
      --secondary: #c0392b; /* Accent Red */
      --accent: #f1c40f; /* Gold */
      --success: #27ae60;
      --warning: #f39c12;
      --info: #3498db;
      --bg: #f4f6f9;
      --white: #ffffff;
      --text: #2c3e50;
      --gray: #95a5a6;
      --border: #e0e0e0;
      --shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    body {
      font-family: 'Segoe UI', 'Roboto', system-ui, sans-serif;
      background-color: var(--bg);
      margin: 0;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      color: var(--text);
      line-height: 1.6;
    }

    .app-container {
      background: var(--white);
      width: 100%;
      max-width: 1200px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: 25px;
      text-align: center;
      position: relative;
      border-bottom: 4px solid var(--accent);
    }
    header h1 { margin: 0; font-size: 28px; font-weight: 700; letter-spacing: 0.5px; }
    header p { margin: 8px 0 0; opacity: 0.9; font-size: 15px; color: #ecf0f1; }
    
    .logout-btn {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 8px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .logout-btn:hover { background: var(--secondary); border-color: var(--secondary); }

    /* Tabs */
    .role-tabs {
      display: flex;
      justify-content: center;
      background: #fff;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      padding: 0 10px;
    }
    .role-tab {
      padding: 15px 30px;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray);
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 0.5px;
    }
    .role-tab:hover { color: var(--primary); background: #f8f9fa; }
    .role-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      background: #f0f4f8;
    }

    /* Auth Section */
    .auth-section { padding: 40px; background: #fff; flex-grow: 1; }
    
    .auth-grid {
      display: grid;
      grid-template-columns: 1fr 1px 1fr;
      gap: 40px;
      max-width: 900px;
      margin: 0 auto;
      align-items: start;
    }
    .divider { background: #eee; height: 100%; width: 1px; }

    .auth-box h3 { 
      color: var(--primary); 
      margin-top: 0; 
      border-bottom: 2px solid #f0f0f0; 
      padding-bottom: 15px;
      margin-bottom: 20px;
      font-size: 20px;
    }

    /* Forms */
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-size: 13px; font-weight: 700; color: #555; text-transform: uppercase; }
    
    input, select {
      width: 100%;
      padding: 12px;
      border: 1px solid #dcdcdc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
      transition: all 0.3s;
      background: #f9f9f9;
    }
    input:focus, select:focus { 
      border-color: var(--primary); 
      background: #fff; 
      box-shadow: 0 0 0 3px rgba(26, 60, 94, 0.1);
      outline: none; 
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      color: white;
      transition: transform 0.1s, opacity 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn:active { transform: scale(0.98); }
    .btn:hover { opacity: 0.95; box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    
    .btn-login { background: var(--primary); }
    .btn-register { background: var(--success); }
    .btn-admin { background: #34495e; }
    .btn-submit { background: var(--primary); margin-top: 20px; font-size: 18px;}

    .msg { font-size: 14px; margin-top: 15px; text-align: center; min-height: 20px; font-weight: 500; }
    .msg.error { color: var(--danger); background: #fdeaea; padding: 10px; border-radius: 4px; border-left: 4px solid var(--danger); }
    .msg.success { color: var(--success); background: #eafaf1; padding: 10px; border-radius: 4px; border-left: 4px solid var(--success); }

    /* Portals */
    .portal-view { padding: 30px; display: none; animation: fadeIn 0.4s ease; }
    .portal-view.active { display: block; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Dashboard Cards */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #eee;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      border-top: 4px solid var(--primary);
      text-align: center;
    }
    .stat-val { font-size: 32px; font-weight: 700; color: var(--primary); margin: 10px 0; }
    .stat-label { color: #7f8c8d; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; }

    /* Student Selection */
    .progress-bar-container {
      background: #e0e0e0;
      height: 10px;
      border-radius: 5px;
      margin: 20px 0;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background: var(--success);
      width: 0%;
      transition: width 0.3s ease;
    }

    .county-block {
      background: #fff;
      border: 1px solid #e1e8ed;
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    .county-header {
      background: #f7f9fa;
      padding: 12px 20px;
      border-bottom: 1px solid #e1e8ed;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .county-header:hover { background: #edf2f7; }
    
    .court-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1px; /* borders handled by bg */
      background: #eee;
      padding: 1px;
      display: none; /* Collapsed by default */
    }
    .court-options.open { display: grid; }

    .court-label {
      display: flex;
      align-items: center;
      padding: 15px;
      background: #fff;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 14px;
    }
    .court-label:hover { background: #f8fdff; }
    .court-label input { width: auto; margin-right: 12px; accent-color: var(--primary); }

    /* Tables */
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; }
    th { background: #f8f9fa; padding: 15px; text-align: left; color: #555; font-weight: 700; border-bottom: 2px solid #e9ecef; }
    td { padding: 15px; border-bottom: 1px solid #eee; background: #fff; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fbfbfb; }

    .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-assigned { background: #d4edda; color: #155724; }
    .status-rejected { background: #f8d7da; color: #721c24; }

    .action-btn {
      padding: 8px 14px;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      margin-right: 5px;
    }
    .btn-assign { background: var(--info); }
    .btn-undo { background: var(--secondary); }
    .btn-approve { background: var(--success); }

    .hidden { display: none !important; }
    
    @media (max-width: 768px) {
      .auth-grid { grid-template-columns: 1fr; gap: 20px; }
      .divider { display: none; }
      .role-tab { padding: 10px 15px; font-size: 12px; }
    }
  </style>
</head>
<body>

<div class="app-container">
  <header>
    <h1>‚öñÔ∏è Judicial Attachment Portal</h1>
    <p>Maseno School of Law ‚Ä¢ Integrated Placement Management System</p>
    <button id="logoutBtn" class="logout-btn hidden" onclick="app.logout()">Sign Out</button>
  </header>

  <!-- AUTHENTICATION VIEW -->
  <div id="authView" class="auth-section">
    <div class="role-tabs">
      <div class="role-tab active" onclick="app.switchTab('student', event)">Student</div>
      <div class="role-tab" onclick="app.switchTab('dean', event)">Dean</div>
      <div class="role-tab" onclick="app.switchTab('admin', event)">Administrator</div>
    </div>

    <!-- STUDENT AUTH -->
    <div id="studentAuth" class="auth-grid active-auth">
      <div class="auth-box">
        <h3>Student Login</h3>
        <form onsubmit="app.handleLogin(event, 'student')">
          <div class="form-group">
            <label>Admission Number</label>
            <input type="text" name="adm" placeholder="e.g. ADM-001" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" name="password" required>
          </div>
          <button type="submit" class="btn btn-login">Access Student Portal</button>
          <div class="msg" id="studentLoginMsg"></div>
        </form>
      </div>
      <div class="divider"></div>
      <div class="auth-box">
        <h3>Student Registration</h3>
        <form onsubmit="app.handleSignup(event, 'student')">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" name="name" placeholder="Towett Kirk" required>
          </div>
          <div class="form-group">
            <label>Admission Number (Unique)</label>
            <input type="text" name="adm" placeholder="e.g. LLB/0000/000" required>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
              <label>Gender</label>
              <select name="gender" required>
                <option value="">Select</option>
                <option>Male</option>
                <option>Female</option>
              </select>
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" name="phone" placeholder="07..." required>
            </div>
          </div>
          <div class="form-group">
            <label>Health Conditions (If any)</label>
            <input type="text" name="health" placeholder="None">
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" name="password" required>
          </div>
          <button type="submit" class="btn btn-register">Create Account</button>
          <div class="msg" id="studentSignupMsg"></div>
        </form>
      </div>
    </div>

    <!-- DEAN AUTH -->
    <div id="deanAuth" class="auth-grid hidden">
      <div class="auth-box">
        <h3>Dean Login</h3>
        <form onsubmit="app.handleLogin(event, 'dean')">
          <div class="form-group">
            <label>Staff ID</label>
            <input type="text" name="id" placeholder="e.g. DEAN-01" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input type="password" name="password" required>
          </div>
          <button type="submit" class="btn btn-login">Access Dean Portal</button>
          <div class="msg" id="deanLoginMsg"></div>
        </form>
      </div>
      <div class="divider"></div>
      <div class="auth-box">
        <h3>Dean Registration</h3>
        <div style="background: #eef2f7; padding: 10px; border-radius: 4px; font-size: 12px; margin-bottom: 15px; border-left: 3px solid var(--primary);">
          <strong>Restricted Access:</strong> Requires Administrative Approval Code.
        </div>
        <form onsubmit="app.handleSignup(event, 'dean')">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" name="name" required>
          </div>
          <div class="form-group">
            <label>Staff ID</label>
            <input type="text" name="id" required>
          </div>
          <div class="form-group">
            <label>Admin Verification Code</label>
            <input type="password" name="adminCode" placeholder="Contact IT Admin" required>
          </div>
          <div class="form-group">
            <label>Create Password</label>
            <input type="password" name="password" required>
          </div>
          <button type="submit" class="btn btn-register">Register Dean</button>
          <div class="msg" id="deanSignupMsg"></div>
        </form>
      </div>
    </div>

    <!-- ADMIN AUTH -->
    <div id="adminAuth" class="auth-grid hidden">
      <div class="auth-box" style="margin: 0 auto; max-width: 400px; grid-column: span 3;">
        <h3 style="text-align: center;">System Administrator</h3>
        <form onsubmit="app.handleLogin(event, 'admin')">
          <div class="form-group">
            <label>Admin Username</label>
            <input type="text" name="id" placeholder="admin" required>
          </div>
          <div class="form-group">
            <label>Master Password</label>
            <input type="password" name="password" required>
          </div>
          <button type="submit" class="btn btn-admin">Access System Control</button>
          <div class="msg" id="adminLoginMsg"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- STUDENT PORTAL -->
  <div id="studentPortal" class="portal-view">
    <div class="dashboard-header">
      <div>
        <h2 style="margin:0">Welcome, <span id="spName">Student</span></h2>
        <small style="color:#666">Admission: <span id="spAdm"></span></small>
      </div>
      <div id="spStatusBadge"></div>
    </div>

    <div id="spSelectionArea">
      <div style="background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <h3 style="margin-top:0">Select Attachment Courts</h3>
        <p>Please select exactly <strong>3 preferred courts</strong>. Your choices will be reviewed by the Dean.</p>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
          <strong>Selection Progress: <span id="spCount">0</span>/3</strong>
          <span id="spList" style="font-size: 13px; color: var(--primary);"></span>
        </div>
        <div class="progress-bar-container">
          <div id="spProgressBar" class="progress-bar-fill"></div>
        </div>

        <div id="courtsContainer" style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
          <!-- JS Injected -->
        </div>

        <button id="spSubmitBtn" class="btn btn-submit" onclick="app.submitChoices()" disabled>Submit Preferences</button>
        <div class="msg" id="spMsg"></div>
      </div>
    </div>
    
    <div id="spResultArea" class="hidden" style="text-align: center; padding: 50px;">
       <!-- JS Injected Success View -->
    </div>
  </div>

  <!-- DEAN PORTAL -->
  <div id="deanPortal" class="portal-view">
    <div class="dashboard-header" style="border-left: 5px solid var(--secondary);">
      <div>
        <h2 style="margin:0">Dean's Dashboard</h2>
        <small>Placement Management</small>
      </div>
      <div>
        <button class="action-btn" style="background:#7f8c8d" onclick="app.refreshDeanView()">Refresh Data</button>
      </div>
    </div>

    <div class="dean-table-container" style="overflow-x: auto;">
      <table id="deanTable">
        <thead>
          <tr>
            <th>Student</th>
            <th>Details</th>
            <th>Preferences</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="deanTableBody">
          <!-- JS Injected -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- ADMIN PORTAL -->
  <div id="adminPortal" class="portal-view">
    <div class="dashboard-header" style="border-left: 5px solid #2c3e50;">
      <div>
        <h2 style="margin:0">Administrator Control Panel</h2>
        <small>System Overview & User Management</small>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-val" id="statTotalStudents">0</div>
        <div class="stat-label">Total Students</div>
      </div>
      <div class="stat-card" style="border-color: var(--success);">
        <div class="stat-val" id="statAssigned">0</div>
        <div class="stat-label">Assigned</div>
      </div>
      <div class="stat-card" style="border-color: var(--warning);">
        <div class="stat-val" id="statPending">0</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card" style="border-color: var(--secondary);">
        <div class="stat-val" id="statDeans">0</div>
        <div class="stat-label">Deans Registered</div>
      </div>
    </div>

    <div style="background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
      <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">Registered Users Database</h3>
      <div style="max-height: 400px; overflow-y: auto;">
        <table>
          <thead>
            <tr>
              <th>ID/Adm</th>
              <th>Name</th>
              <th>Role</th>
              <th>Joined</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="adminUserTable"></tbody>
        </table>
      </div>
    </div>

    <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid var(--secondary);">
      <h3 style="color: var(--secondary); margin-top:0;">Danger Zone</h3>
      <p>Resetting the system will delete all user data, choices, and assignments.</p>
      <button class="btn" style="background: var(--secondary); width: auto;" onclick="app.resetSystem()">Factory Reset System</button>
    </div>
  </div>

</div>

<script>
/* --- CONFIGURATION --- */
const CONFIG = {
  deanCode: '0480173679518',
  adminUser: 'Admin_1010',
  adminPass: 'Admin1010',
  // 47 COUNTIES - Comprehensive Court List
  courts: {
    "01. Mombasa County": [
      "Mombasa Law Courts", "Mombasa Court of Appeal", "Shanzu Law Courts", 
      "Tononoka Children's Court", "Mombasa Kadhis Court", "Mombasa Employment & Labour Court"
    ],
    "02. Kwale County": [
      "Kwale Law Courts", "Msambweni Law Courts", "Kinango Law Courts", "Kwale Kadhis Court"
    ],
    "03. Kilifi County": [
      "Kilifi Law Courts", "Malindi Law Courts", "Malindi High Court", "Kaloleni Law Courts", 
      "Mariakani Law Courts", "Malindi Kadhis Court"
    ],
    "04. Tana River County": [
      "Hola Law Courts", "Garsen Law Courts", "Hola Kadhis Court"
    ],
    "05. Lamu County": [
      "Lamu Law Courts", "Mpeketoni Law Courts", "Lamu Kadhis Court"
    ],
    "06. Taita-Taveta County": [
      "Voi Law Courts", "Voi High Court", "Wundanyi Law Courts", "Taveta Law Courts", "Voi Kadhis Court"
    ],
    "07. Garissa County": [
      "Garissa Law Courts", "Garissa High Court", "Ijara Law Courts", "Dadaab Kadhis Court"
    ],
    "08. Wajir County": [
      "Wajir Law Courts", "Habaswein Kadhis Court", "Wajir Kadhis Court"
    ],
    "09. Mandera County": [
      "Mandera Law Courts", "El Wak Law Courts", "Takaba Kadhis Court"
    ],
    "10. Marsabit County": [
      "Marsabit Law Courts", "Moyale Law Courts", "Marsabit Kadhis Court"
    ],
    "11. Isiolo County": [
      "Isiolo Law Courts", "Garbatulla Kadhis Court", "Isiolo Kadhis Court"
    ],
    "12. Meru County": [
      "Meru Law Courts", "Meru High Court", "Maua Law Courts", "Nkubu Law Courts", "Githongo Law Courts"
    ],
    "13. Tharaka-Nithi County": [
      "Chuka Law Courts", "Chuka High Court", "Marimanti Law Courts"
    ],
    "14. Embu County": [
      "Embu Law Courts", "Embu High Court", "Siakago Law Courts", "Runyenjes Law Courts"
    ],
    "15. Kitui County": [
      "Kitui Law Courts", "Kitui High Court", "Mwingi Law Courts", "Mutomo Law Courts", "Kyuso Law Courts"
    ],
    "16. Machakos County": [
      "Machakos Law Courts", "Machakos High Court", "Mavoko Law Courts", "Kangundo Law Courts", "Kithimani Law Courts"
    ],
    "17. Makueni County": [
      "Makueni Law Courts", "Makueni High Court", "Makindu Law Courts", "Kilungu Law Courts", "Tawa Law Courts"
    ],
    "18. Nyandarua County": [
      "Ol Kalou Law Courts", "Nyahururu Law Courts", "Engineer Law Courts"
    ],
    "19. Nyeri County": [
      "Nyeri Law Courts", "Nyeri High Court", "Karatina Law Courts", "Othaya Law Courts", "Mukurwe-ini Law Courts"
    ],
    "20. Kirinyaga County": [
      "Kerugoya Law Courts", "Kerugoya High Court", "Wang'uru Law Courts", "Baricho Law Courts"
    ],
    "21. Murang'a County": [
      "Murang'a Law Courts", "Murang'a High Court", "Kigumo Law Courts", "Kangema Law Courts", 
      "Kandara Law Courts", "Gatanga Law Courts", "Kenol Law Courts"
    ],
    "22. Kiambu County": [
      "Kiambu Law Courts", "Kiambu High Court", "Thika Law Courts", "Thika High Court", 
      "Limuru Law Courts", "Githunguri Law Courts", "Kikuyu Law Courts", "Gatundu Law Courts", "Ruiru Law Courts"
    ],
    "23. Turkana County": [
      "Lodwar Law Courts", "Lodwar High Court", "Kakuma Law Courts"
    ],
    "24. West Pokot County": [
      "Kapenguria Law Courts", "Kapenguria High Court"
    ],
    "25. Samburu County": [
      "Maralal Law Courts", "Maralal High Court"
    ],
    "26. Trans-Nzoia County": [
      "Kitale Law Courts", "Kitale High Court"
    ],
    "27. Uasin Gishu County": [
      "Eldoret Law Courts", "Eldoret High Court", "Moiben Law Courts", "Eldoret Kadhis Court"
    ],
    "28. Elgeyo-Marakwet County": [
      "Iten Law Courts", "Tambach Law Courts"
    ],
    "29. Nandi County": [
      "Kapsabet Law Courts", "Kapsabet High Court", "Mosoriot Law Courts", 
      "Kabiyet Law Courts", "Tinderet Law Courts"
    ],
    "30. Baringo County": [
      "Kabarnet Law Courts", "Kabarnet High Court", "Eldama Ravine Law Courts", "Marigat Law Courts"
    ],
    "31. Laikipia County": [
      "Nanyuki Law Courts", "Nanyuki High Court", "Rumuruti Law Courts"
    ],
    "32. Nakuru County": [
      "Nakuru Law Courts", "Nakuru High Court", "Naivasha Law Courts", "Molo Law Courts", "Gilgil Law Courts"
    ],
    "33. Narok County": [
      "Narok Law Courts", "Narok High Court", "Kilgoris Law Courts"
    ],
    "34. Kajiado County": [
      "Kajiado Law Courts", "Kajiado High Court", "Ngong Law Courts", "Loitokitok Law Courts"
    ],
    "35. Kericho County": [
      "Kericho Law Courts", "Kericho High Court", "Sosiot Law Courts"
    ],
    "36. Bomet County": [
      "Bomet Law Courts", "Bomet High Court", "Sotik Law Courts"
    ],
    "37. Kakamega County": [
      "Kakamega Law Courts", "Kakamega High Court", "Mumias Law Courts", "Butere Law Courts"
    ],
    "38. Vihiga County": [
      "Vihiga Law Courts", "Vihiga High Court", "Hamisi Law Courts"
    ],
    "39. Bungoma County": [
      "Bungoma Law Courts", "Bungoma High Court", "Kimilili Law Courts", "Webuye Law Courts", "Sirisia Law Courts"
    ],
    "40. Busia County": [
      "Busia Law Courts", "Busia High Court", "Port Victoria Law Courts"
    ],
    "41. Siaya County": [
      "Siaya Law Courts", "Siaya High Court", "Bondo Law Courts", "Ukwala Law Courts", "Madiany Law Courts"
    ],
    "42. Kisumu County": [
      "Kisumu Law Courts", "Kisumu High Court", "Winam Law Courts", "Maseno Law Courts", 
      "Tamu Law Courts", "Nyando (Ahero) Law Courts"
    ],
    "43. Homa Bay County": [
      "Homa Bay Law Courts", "Homa Bay High Court", "Oyugis Law Courts", "Ndhiwa Law Courts", "Mbita Law Courts"
    ],
    "44. Migori County": [
      "Migori Law Courts", "Migori High Court", "Rongo Law Courts", "Kehancha Law Courts", "Macalder Law Courts"
    ],
    "45. Kisii County": [
      "Kisii Law Courts", "Kisii High Court", "Ogembo Law Courts", "Nyamarambe Law Courts"
    ],
    "46. Nyamira County": [
      "Nyamira Law Courts", "Nyamira High Court", "Keroka Law Courts"
    ],
    "47. Nairobi City County": [
      "Supreme Court of Kenya", "Court of Appeal", "Milimani High Court", "Milimani Commercial Courts", 
      "Milimani Children's Court", "Nairobi City Court", "Makadara Law Courts", "Kibera Law Courts", 
      "JKIA Magistrate Court", "Kahawa Law Courts", "Nairobi Small Claims Court"
    ]
  }
};

/* --- APPLICATION LOGIC --- */
const app = {
  // State Management
  data: {
    users: JSON.parse(localStorage.getItem('jap_users')) || {},
    choices: JSON.parse(localStorage.getItem('jap_choices')) || {},
    assignments: JSON.parse(localStorage.getItem('jap_assignments')) || {},
  },
  currentUser: null,
  currentSelection: [],

  init: function() {
    this.renderCourts();
    // Check for Admin account initialization
    if (!this.data.users['admin']) {
      // Optional: Initialize logic if needed, but admin is hardcoded in login check
    }
  },

  save: function() {
    localStorage.setItem('jap_users', JSON.stringify(this.data.users));
    localStorage.setItem('jap_choices', JSON.stringify(this.data.choices));
    localStorage.setItem('jap_assignments', JSON.stringify(this.data.assignments));
  },

  /* --- NAVIGATION & UI --- */
  switchTab: function(role, event) {
    // Update UI Tabs
    document.querySelectorAll('.role-tab').forEach(t => t.classList.remove('active'));
    if(event) event.currentTarget.classList.add('active');

    // Toggle Auth Forms
    document.getElementById('studentAuth').className = 'auth-grid hidden';
    document.getElementById('deanAuth').className = 'auth-grid hidden';
    document.getElementById('adminAuth').className = 'auth-grid hidden';

    document.getElementById(`${role}Auth`).className = 'auth-grid';
  },

  toggleCounty: function(header) {
    const options = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    if (options.classList.contains('open')) {
      options.classList.remove('open');
      icon.textContent = '+';
    } else {
      options.classList.add('open');
      icon.textContent = '-';
    }
  },

  showMsg: function(elId, text, type) {
    const el = document.getElementById(elId);
    el.textContent = text;
    el.className = `msg ${type}`;
    setTimeout(() => { el.textContent = ''; el.className = 'msg'; }, 4000);
  },

  /* --- AUTHENTICATION --- */
  handleSignup: function(e, role) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const data = Object.fromEntries(fd.entries());
    const msgId = `${role}SignupMsg`;

    // Dean Code Check
    if (role === 'dean' && data.adminCode !== CONFIG.deanCode) {
      return this.showMsg(msgId, "Invalid Verification Code!", "error");
    }

    const id = role === 'student' ? data.adm.trim().toUpperCase() : data.id.trim().toUpperCase();

    if (this.data.users[id]) {
      return this.showMsg(msgId, "User ID already exists!", "error");
    }

    this.data.users[id] = {
      ...data,
      id: id,
      role: role,
      joined: new Date().toLocaleDateString()
    };
    this.save();
    this.showMsg(msgId, "Registration successful! Please login.", "success");
    e.target.reset();
  },

  handleLogin: function(e, role) {
    e.preventDefault();
    const fd = new FormData(e.target);
    const id = fd.get('id') || fd.get('adm');
    const password = fd.get('password');
    const msgId = `${role}LoginMsg`;

    // Special Admin Login
    if (role === 'admin') {
      if (id === CONFIG.adminUser && password === CONFIG.adminPass) {
        this.login({ id: 'ADMIN', name: 'System Administrator', role: 'admin' });
        return;
      } else {
        return this.showMsg(msgId, "Invalid Admin Credentials", "error");
      }
    }

    // Regular Login
    const user = this.data.users[id.trim().toUpperCase()];
    if (user && user.role === role && user.password === password) {
      this.login(user);
    } else {
      this.showMsg(msgId, "Invalid ID or Password", "error");
    }
  },

  login: function(user) {
    this.currentUser = user;
    document.getElementById('authView').classList.add('hidden');
    document.getElementById('logoutBtn').classList.remove('hidden');

    if (user.role === 'student') this.loadStudentPortal();
    else if (user.role === 'dean') this.loadDeanPortal();
    else if (user.role === 'admin') this.loadAdminPortal();
  },

  logout: function() {
    this.currentUser = null;
    this.currentSelection = [];
    location.reload(); // Simplest way to reset all view states
  },

  /* --- STUDENT LOGIC --- */
  loadStudentPortal: function() {
    document.getElementById('studentPortal').classList.add('active');
    document.getElementById('spName').textContent = this.currentUser.name;
    document.getElementById('spAdm').textContent = this.currentUser.id;

    const id = this.currentUser.id;
    const assignment = this.data.assignments[id];
    const choices = this.data.choices[id];

    const selectionArea = document.getElementById('spSelectionArea');
    const resultArea = document.getElementById('spResultArea');
    const statusBadge = document.getElementById('spStatusBadge');

    if (assignment) {
      statusBadge.innerHTML = `<span class="status-badge status-assigned">Confirmed</span>`;
      selectionArea.classList.add('hidden');
      resultArea.classList.remove('hidden');
      resultArea.innerHTML = `
        <div style="font-size: 50px;">üéâ</div>
        <h2 style="color: var(--success);">Attachment Confirmed!</h2>
        <p>You have been posted to:</p>
        <h1 style="color: var(--primary);">${assignment}</h1>
        <p>Please download your admission letter from the registry.</p>
      `;
    } else if (choices) {
      statusBadge.innerHTML = `<span class="status-badge status-pending">Pending Review</span>`;
      selectionArea.classList.add('hidden');
      resultArea.classList.remove('hidden');
      resultArea.innerHTML = `
        <div style="font-size: 50px;">‚è≥</div>
        <h2>Choices Submitted</h2>
        <p>You have selected:</p>
        <ul style="list-style:none; padding:0; font-weight:bold; color: #555;">
          ${choices.map(c => `<li style="padding:5px;">üìç ${c}</li>`).join('')}
        </ul>
        <p>Awaiting Dean's approval.</p>
      `;
    } else {
      statusBadge.innerHTML = `<span class="status-badge status-rejected">Action Required</span>`;
      selectionArea.classList.remove('hidden');
      resultArea.classList.add('hidden');
    }
  },

  renderCourts: function() {
    const container = document.getElementById('courtsContainer');
    container.innerHTML = '';

    Object.entries(CONFIG.courts).forEach(([county, courts], index) => {
      const block = document.createElement('div');
      block.className = 'county-block';
      
      // Auto-expand first county, collapse others
      const isOpen = index === 0 ? 'open' : '';
      const icon = index === 0 ? '-' : '+';
      
      block.innerHTML = `
        <div class="county-header" onclick="app.toggleCounty(this)">
          ${county}
          <span class="toggle-icon" style="font-weight:bold; font-size:18px;">${icon}</span>
        </div>
        <div class="court-options ${isOpen}">
          ${courts.map(court => `
            <label class="court-label">
              <input type="checkbox" value="${court}" onchange="app.handleSelection(this)">
              ${court}
            </label>
          `).join('')}
        </div>
      `;
      container.appendChild(block);
    });
  },

  handleSelection: function(el) {
    const val = el.value;
    
    if (el.checked) {
      if (this.currentSelection.length >= 3) {
        el.checked = false;
        this.showMsg('spMsg', "Maximum 3 courts allowed!", "error");
        return;
      }
      this.currentSelection.push(val);
    } else {
      this.currentSelection = this.currentSelection.filter(c => c !== val);
    }

    // Update UI
    const count = this.currentSelection.length;
    document.getElementById('spCount').textContent = count;
    document.getElementById('spList').textContent = this.currentSelection.join(', ');
    
    // Progress Bar
    const percentage = (count / 3) * 100;
    document.getElementById('spProgressBar').style.width = `${percentage}%`;
    
    // Submit Button Logic
    const btn = document.getElementById('spSubmitBtn');
    if (count === 3) {
      btn.disabled = false;
      btn.style.opacity = '1';
    } else {
      btn.disabled = true;
      btn.style.opacity = '0.5';
    }
  },

  submitChoices: function() {
    if (this.currentSelection.length !== 3) return;
    
    if(confirm("Are you sure you want to submit these 3 choices? This cannot be undone.")) {
      this.data.choices[this.currentUser.id] = this.currentSelection;
      this.save();
      this.loadStudentPortal(); // Refresh
    }
  },

  /* --- DEAN LOGIC --- */
  loadDeanPortal: function() {
    document.getElementById('deanPortal').classList.add('active');
    this.refreshDeanView();
  },

  refreshDeanView: function() {
    const tbody = document.getElementById('deanTableBody');
    tbody.innerHTML = '';
    
    const students = Object.values(this.data.users).filter(u => u.role === 'student');
    
    if(students.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No students found in system.</td></tr>';
      return;
    }

    students.forEach(stu => {
      const choices = this.data.choices[stu.id];
      const assigned = this.data.assignments[stu.id];
      const row = document.createElement('tr');

      // Status Column
      let statusHtml = '<span class="status-badge status-rejected">Not Submitted</span>';
      if (assigned) statusHtml = '<span class="status-badge status-assigned">Assigned</span>';
      else if (choices) statusHtml = '<span class="status-badge status-pending">Pending</span>';

      // Choices / Actions
      let prefHtml = '<span style="color:#999">Waiting for submission...</span>';
      let actionHtml = '-';

      if (assigned) {
        prefHtml = `<strong style="color:var(--success)">${assigned}</strong>`;
        actionHtml = `<button class="action-btn btn-undo" onclick="app.deanAction('undo', '${stu.id}')">Revoke</button>`;
      } else if (choices) {
        // Dropdown for assignment
        const options = choices.map(c => `<option value="${c}">${c}</option>`).join('');
        prefHtml = `
          <select id="assign-${stu.id}" style="padding:5px; border-radius:4px; border:1px solid #ccc;">
            ${options}
          </select>
        `;
        actionHtml = `<button class="action-btn btn-assign" onclick="app.deanAction('assign', '${stu.id}')">Assign</button>`;
      }

      row.innerHTML = `
        <td>
          <strong>${stu.name}</strong><br>
          <span style="font-size:12px; color:#666;">${stu.id}</span>
        </td>
        <td style="font-size:13px;">
          ${stu.gender}, ${stu.phone}<br>
          <span style="color:${stu.health ? '#e74c3c' : '#27ae60'}">${stu.health || 'Fit'}</span>
        </td>
        <td>${prefHtml}</td>
        <td>${statusHtml}</td>
        <td>${actionHtml}</td>
      `;
      tbody.appendChild(row);
    });
  },

  deanAction: function(action, id) {
    if (action === 'assign') {
      const val = document.getElementById(`assign-${id}`).value;
      this.data.assignments[id] = val;
      alert(`Student assigned to ${val}`);
    } else if (action === 'undo') {
      if(!confirm('Revoke this assignment?')) return;
      delete this.data.assignments[id];
    }
    this.save();
    this.refreshDeanView();
  },

  /* --- ADMIN LOGIC --- */
  loadAdminPortal: function() {
    document.getElementById('adminPortal').classList.add('active');
    
    // Calculate Stats
    const students = Object.values(this.data.users).filter(u => u.role === 'student');
    const deans = Object.values(this.data.users).filter(u => u.role === 'dean');
    const assignedCount = Object.keys(this.data.assignments).length;
    
    document.getElementById('statTotalStudents').textContent = students.length;
    document.getElementById('statAssigned').textContent = assignedCount;
    document.getElementById('statPending').textContent = students.length - assignedCount;
    document.getElementById('statDeans').textContent = deans.length;

    // Render User Table
    const tbody = document.getElementById('adminUserTable');
    tbody.innerHTML = '';
    
    Object.values(this.data.users).forEach(u => {
      if(u.role === 'admin') return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${u.id}</td>
        <td>${u.name}</td>
        <td><span class="status-badge" style="background:${u.role === 'dean' ? '#e8f4fd' : '#f9f9f9'}">${u.role.toUpperCase()}</span></td>
        <td>${u.joined || '-'}</td>
        <td><button class="action-btn btn-undo" onclick="app.deleteUser('${u.id}')">Delete</button></td>
      `;
      tbody.appendChild(tr);
    });
  },

  deleteUser: function(id) {
    if(confirm(`Delete user ${id} and all their data permanently?`)) {
      delete this.data.users[id];
      delete this.data.choices[id];
      delete this.data.assignments[id];
      this.save();
      this.loadAdminPortal();
    }
  },

  resetSystem: function() {
    const code = prompt("Type 'RESET' to wipe all database:");
    if(code === 'RESET') {
      localStorage.removeItem('jap_users');
      localStorage.removeItem('jap_choices');
      localStorage.removeItem('jap_assignments');
      location.reload();
    }
  }
};

// Start App
app.init();
</script>
</body>
</html>